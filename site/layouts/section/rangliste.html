{{ define "main" }}

  <h1 class="center tc f2 pa2">Rangliste</h1>
  <div class="center grey-3 tc">
    <p class="center tc">{{ .Date.Format "Mon, Jan 2, 2006" }}</p>
  </div>
  
  {{ if .Params.image }}<div class="center"><img src="{{ .Params.image }}" alt="{{ .Title }}" /></div>{{ end }}

  <div class="pa2" style="position: fixed; top: 20px; right:20px; background-color: rgb(250, 250, 250);">
    <h2 class="tc">Mein Tipp</h2>
    <div id="myBet"></div>
  </div>

  <div id="autoRankingList">
  </div>

  <script src="/game/game.js"></script>
  <script>
    (function() {
      fetch("https://dabeiseinistalles.blob.core.windows.net/data/prices.json")
        .then(function(res){ return res.json() })
        .then(function(prices){
          var byValorSymbol = mapByValorSymbol(prices)
          var referenceDate = "20200327"
          initRankingList(referenceDate, byValorSymbol, getBets())
          initMyBet(byValorSymbol, getValorSymbolsUsed(), referenceDate)
        })

        function initRankingList(referenceDate, prices, players) {
          var rankingListData = calculateRankingList(referenceDate, prices, players)
          document.getElementById("autoRankingList").innerHTML = rangkingListHtmlTable(rankingListData)
        }

        function initMyBet(byValorSymbol, valorSymbolsUsed, referenceDate) {
          var container = document.getElementById("myBet")
          var allStocks = valorSymbolsUsed
            .map(function(valorSymbol){ 
              return {
                valorSymbol: valorSymbol, 
                shortName: byValorSymbol[valorSymbol].shortName
              }
            })

          var defaultSelection = getSelection() ||Â (function(){
            var firstValorSymbol = allStocks[0].valorSymbol
            return [firstValorSymbol, firstValorSymbol, firstValorSymbol, firstValorSymbol]
          })()

          var totalDiv = document.createElement("div")
          var controls = defaultSelection.map(function(valorSymbol) {
            var stockContainer = document.createElement("div")
            var stockSelector = createStockSelector(valorSymbol, allStocks, onChange)
            var stockInfoControl = createStockInfoControl()
            stockContainer.appendChild(stockSelector.element)
            stockContainer.appendChild(stockInfoControl.element)
            container.appendChild(stockContainer)
            return {
              stockSelector: stockSelector,
              stockInfoControl: stockInfoControl
            }
          }) 
          updateInfo()
          container.appendChild(totalDiv)

          function onChange(){
            saveSelection()
            updateInfo()
          }

          function saveSelection() {
            var selection = controls.map(function(c) {
              return c.stockSelector.selectedValorSymbol()
            })
            localStorage.setItem("selection", JSON.stringify(selection))
          }

          function getSelection() {
            var raw = localStorage.getItem("selection")
            return raw ? JSON.parse(raw) : null
          }

          function updateInfo() {
            var totalPerformance = 0
            controls.forEach(function(control){
              var sourceStockData = byValorSymbol[control.stockSelector.selectedValorSymbol()]
              var latestItem = sourceStockData.prices[0]

              var stockData = {
                reference: { closingPrice: sourceStockData.referenceDatePrice, lastDate: formatDate(parseDate(referenceDate)) },
                latest: { closingPrice: latestItem.closingPrice, lastDate: formatDate(parseDate(latestItem.lastDate)) },
                performance: calculatePerformance(sourceStockData.referenceDatePrice, latestItem.closingPrice)
              }
              totalPerformance += stockData.performance
              control.stockInfoControl.update(stockData)
            })
            totalDiv.innerHTML = formatPercent(totalPerformance).toString() + "%"
          }
        }

        function makeInfoHtml(stockData) {
          return '<div>Referenzpreis ' + stockData.reference.lastDate +'</div>' +
            '<div>' + stockData.reference.closingPrice + '</div>' +
            '<div>Letzter Preis ' + stockData.latest.lastDate + '</div>' +
            '<div>' + stockData.reference.closingPrice + '</div>' +
            '<div>Performance</div>' +
            '<div>' + formatPercent(stockData.performance) + '%</div>'
        }

        function createStockSelector(defaultSelection, allStocks, onChange) {
          var select = document.createElement("select")
          allStocks.forEach(function(stock) {
            var option = document.createElement("option")
            option.value = stock.valorSymbol
            option.innerHTML = stock.shortName
            select.appendChild(option)
          })
          select.addEventListener("change", function(e) {
            onChange(e.target.value)
          })
          select.value = defaultSelection
          return {
            element: select,
            selectedValorSymbol: function() {
              return select.value
            }
          }
        }

        function createStockInfoControl() {
          var container = document.createElement("div")
          container.style.fontSize = "0.5rem"
          return {
            update: function(stockData) {
              container.innerHTML = makeInfoHtml(stockData)
            },
            element: container
          }
        }
    })()
  </script>

{{ end }}

